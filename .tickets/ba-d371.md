---
id: ba-d371
status: open
deps: [ba-160d, ba-1253]
links: []
created: 2026-01-29T18:14:34Z
type: task
priority: 2
assignee: vot3k
parent: ba-0cdb
---
# Write end-to-end integration test for full cluster workflow

## Objective
Create an end-to-end test that validates the full orchestration workflow with multiple simulated hosts.

## Location
- New file: tests/e2e/cluster_test.go (or internal/orchestrator/e2e_test.go)

## Implementation Details

### Test Setup
1. Start 2-3 vmm-api instances on different ports (using httptest servers or real servers with --no-tls)
2. Configure vmm-ctl with both hosts
3. Generate test TLS certificates (or use --no-tls for testing)

### Test Scenarios

**Test: Full Lifecycle**
1. vmm-ctl host list → both hosts shown as healthy
2. vmm-ctl create vm-1 --cpus 1 --memory 512 → placed on a host
3. vmm-ctl create vm-2 --cpus 1 --memory 512 → placed (may be different host)
4. vmm-ctl list → shows both VMs with correct hosts
5. vmm-ctl status → shows cluster summary
6. vmm-ctl delete vm-1 → deleted from correct host
7. vmm-ctl delete vm-2 → deleted

**Test: Duplicate Name Prevention**
1. Create vm-1 on host-a
2. Create vm-1 (auto-placed) → error "VM already exists"

**Test: Host Failure Handling**
1. Create VMs on both hosts
2. Shut down one host
3. vmm-ctl list → shows VMs from surviving host, notes unreachable host
4. vmm-ctl host list → shows one healthy, one unhealthy

**Test: Placement Strategy**
1. Configure least-loaded strategy
2. Create 4 VMs with varying resource requirements
3. Verify placement distributes across hosts based on available resources

### Test Execution
- These tests require test infrastructure (multiple server processes)
- Use build tags: //go:build e2e
- Run with: go test -tags=e2e ./tests/e2e/
- CI: optional (requires more setup), primarily for local validation

## Acceptance Criteria
- E2E tests cover full lifecycle, duplicate prevention, failure handling, placement
- Tests use test-only infrastructure (no real Firecracker)
- Tests are isolated (no side effects between test runs)
- go test -tags=e2e ./tests/e2e/ passes

## Acceptance Criteria

E2E tests pass for full lifecycle, duplicate prevention, failure handling, placement

