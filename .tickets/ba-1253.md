---
id: ba-1253
status: open
deps: [ba-dca5, ba-257c, ba-8faf, ba-8105]
links: []
created: 2026-01-29T18:11:42Z
type: task
priority: 0
assignee: vot3k
parent: ba-3d4c
---
# Create vmm-api binary entry point

## Objective
Create the main entry point for the vmm-api daemon binary.

## Location
- New file: cmd/vmm-api/main.go

## Implementation Details

### CLI Flags
```go
var (
    listenAddr string  // --listen, default ":8443"
    certFile   string  // --cert, path to server TLS certificate
    keyFile    string  // --key, path to server TLS private key
    caFile     string  // --ca, path to CA certificate for client verification
    configPath string  // --config, path to VMM config file (default: auto-detect)
    noTLS      bool    // --no-tls, disable TLS (for development/testing only)
)
```

### Startup Flow
1. Parse CLI flags
2. Load VMM config: config.Load(configPath) or config.Load(config.ConfigPath())
3. Ensure directories exist: cfg.EnsureDirectories()
4. Create API server: api.NewServer(cfg)
5. Set up signal handling (SIGINT, SIGTERM)
6. If TLS enabled: server.ListenAndServeTLS(listenAddr, certFile, keyFile, caFile)
7. If --no-tls: server.ListenAndServe(listenAddr) â€” WARNING logged
8. On signal: graceful shutdown with 30s timeout

### Logging
- Log startup info: listen address, TLS mode, data directory
- Log shutdown reason and duration
- Use slog with JSON format for production, text format if TTY

### Build-Time Variables
```go
var (
    version = "dev"
    commit  = "unknown"
    date    = "unknown"
)
```
These are injected via ldflags (same pattern as cmd/vmm/main.go).
Pass to api.Server for /v1/health version reporting.

### Process Requirements
- Must run as root (Firecracker/networking require root)
- Log warning if running without TLS
- Log error and exit if cert/key/ca files don't exist when TLS is requested
- PID file: /var/run/vmm-api.pid (optional, systemd manages this)

## Example Usage
```bash
# Production (mTLS)
vmm-api --listen :8443 --cert /etc/vmm/tls/server.crt --key /etc/vmm/tls/server.key --ca /etc/vmm/tls/ca.crt

# Development (no TLS)
vmm-api --listen :8080 --no-tls

# Custom config
vmm-api --listen :8443 --cert ... --config /path/to/config.json
```

## Acceptance Criteria
- vmm-api binary starts and listens on configured port
- --no-tls mode works for local development
- Graceful shutdown on SIGINT/SIGTERM
- Version info displayed at startup and via /v1/health
- Exits with error if TLS files are missing

## Acceptance Criteria

Binary starts, listens, and shuts down gracefully; --no-tls works for dev; version displayed

