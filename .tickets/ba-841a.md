---
id: ba-841a
status: open
deps: [ba-dec6]
links: []
created: 2026-01-29T18:13:59Z
type: task
priority: 2
assignee: vot3k
parent: ba-0cdb
---
# Add retry logic with exponential backoff to orchestrator client

## Objective
Add configurable retry logic to the orchestrator HTTP client for handling transient network failures.

## Location
- Modify: internal/orchestrator/client.go

## Implementation Details

### Retry Configuration
```go
type RetryConfig struct {
    MaxRetries  int           // Default: 3
    BaseDelay   time.Duration // Default: 500ms
    MaxDelay    time.Duration // Default: 10s
    RetryOn     []int         // HTTP status codes to retry (default: 502, 503, 504)
}
```

### Exponential Backoff with Jitter
```go
func (c *HostClient) doWithRetry(ctx context.Context, req *http.Request) (*http.Response, error) {
    for attempt := 0; attempt <= c.retry.MaxRetries; attempt++ {
        resp, err := c.httpClient.Do(req)

        if err == nil && !isRetryable(resp.StatusCode) {
            return resp, nil
        }

        if attempt < c.retry.MaxRetries {
            delay := min(c.retry.BaseDelay * (1 << attempt), c.retry.MaxDelay)
            jitter := time.Duration(rand.Int63n(int64(delay / 2)))
            select {
            case <-ctx.Done():
                return nil, ctx.Err()
            case <-time.After(delay + jitter):
            }
        }
    }
    return nil, fmt.Errorf("request failed after %d retries", c.retry.MaxRetries)
}
```

### Retry Rules
- Retry on: network errors (connection refused, timeout), HTTP 502/503/504
- Don't retry on: 4xx errors (client errors), HTTP 500 (server bug, not transient)
- Don't retry on: POST requests that may not be idempotent (VM create)
  - Exception: POST to /start and /stop are idempotent and safe to retry
- Respect context cancellation during backoff waits

### Idempotency Awareness
- GET, DELETE: always safe to retry
- POST /v1/vms/{name}/start: safe (starting an already-running VM is a no-op)
- POST /v1/vms/{name}/stop: safe (stopping an already-stopped VM is a no-op)
- POST /v1/vms: NOT safe to retry (could create duplicate if first succeeded but response was lost)
  - For create: fail after first network error with clear message

### Configurable via vmm-ctl config
```json
{
  "retry": {
    "max_retries": 3,
    "base_delay_ms": 500,
    "max_delay_ms": 10000
  }
}
```

## Acceptance Criteria
- Transient failures are retried with exponential backoff + jitter
- 4xx errors are not retried
- VM create is not retried after ambiguous failure
- Context cancellation stops retry loop immediately
- Retry behavior is configurable

## Acceptance Criteria

Transient failures retried; 4xx not retried; create not retried; context cancellation respected

