---
id: ba-3440
status: open
deps: [ba-1253, ba-160d]
links: []
created: 2026-01-29T18:13:59Z
type: task
priority: 1
assignee: vot3k
parent: ba-0cdb
---
# Update Makefile and GoReleaser for vmm-api and vmm-ctl binaries

## Objective
Update the build infrastructure to produce three binaries: vmm, vmm-api, and vmm-ctl.

## Location
- Modify: Makefile
- Modify: .goreleaser.yaml

## Implementation Details

### Makefile Updates
Add targets for all three binaries:
```makefile
.PHONY: build build-api build-ctl build-all

LDFLAGS := -X main.version=$(VERSION) -X main.commit=$(COMMIT) -X main.date=$(DATE)

build:          # Build vmm CLI (existing)
    go build -ldflags "$(LDFLAGS)" -o vmm ./cmd/vmm/

build-api:      # Build vmm-api daemon
    go build -ldflags "$(LDFLAGS)" -o vmm-api ./cmd/vmm-api/

build-ctl:      # Build vmm-ctl orchestrator
    go build -ldflags "$(LDFLAGS)" -o vmm-ctl ./cmd/vmm-ctl/

build-all: build build-api build-ctl  # Build everything

install-all: build-all
    cp vmm vmm-api vmm-ctl /usr/local/bin/

test:
    go test ./...

clean:
    rm -f vmm vmm-api vmm-ctl
```

### GoReleaser Updates (.goreleaser.yaml)
Add multiple builds:
```yaml
builds:
  - id: vmm
    main: ./cmd/vmm
    binary: vmm
    goos: [linux]
    goarch: [amd64]
    ldflags:
      - -s -w -X main.version={{.Version}} ...

  - id: vmm-api
    main: ./cmd/vmm-api
    binary: vmm-api
    goos: [linux]
    goarch: [amd64]
    ldflags:
      - -s -w -X main.version={{.Version}} ...

  - id: vmm-ctl
    main: ./cmd/vmm-ctl
    binary: vmm-ctl
    goos: [linux, darwin]  # ctl can run from macOS
    goarch: [amd64, arm64]
    ldflags:
      - -s -w -X main.version={{.Version}} ...
```

Note: vmm-ctl cross-compiles for macOS/arm64 since the orchestrator doesn't need Linux/KVM â€” it's just an HTTP client.

### Archive Configuration
```yaml
archives:
  - id: vmm-server
    builds: [vmm, vmm-api]
    name_template: "vmm-server_{{ .Version }}_{{ .Os }}_{{ .Arch }}"
    files:
      - scripts/*
      - README.md
      - LICENSE

  - id: vmm-ctl
    builds: [vmm-ctl]
    name_template: "vmm-ctl_{{ .Version }}_{{ .Os }}_{{ .Arch }}"
    files:
      - LICENSE
```

## Acceptance Criteria
- make build-all produces vmm, vmm-api, vmm-ctl binaries
- make test runs all tests across all packages
- GoReleaser produces separate server and client archives
- vmm-ctl archive available for linux/amd64, darwin/amd64, darwin/arm64
- Version info injected into all three binaries

## Acceptance Criteria

make build-all produces 3 binaries; GoReleaser creates separate archives; version info in all

