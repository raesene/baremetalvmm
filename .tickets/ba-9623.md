---
id: ba-9623
status: open
deps: [ba-257c, ba-8faf, ba-8105]
links: []
created: 2026-01-29T18:11:43Z
type: task
priority: 1
assignee: vot3k
parent: ba-3d4c
---
# Write unit tests for API handlers and response helpers

## Objective
Write unit tests for the API package — handlers, response helpers, and middleware.

## Location
- New file: internal/api/responses_test.go
- New file: internal/api/handlers_test.go
- New file: internal/api/middleware_test.go

## Implementation Details

### Response Tests (responses_test.go)
- TestWriteJSON: verify JSON envelope format, Content-Type header, status code
- TestWriteError: verify error envelope format, correct HTTP status codes
- TestErrorCodes: verify all error code constants are valid strings

### Handler Tests (handlers_test.go)
Use httptest.NewServer and httptest.NewRecorder for isolated testing.

**Test Setup:**
Create a test server with temporary directories:
```go
func newTestServer(t *testing.T) *Server {
    t.Helper()
    tmpDir := t.TempDir()
    cfg := config.DefaultConfig()
    cfg.DataDir = tmpDir
    cfg.EnsureDirectories()
    return NewServer(cfg)
}
```

**Test Cases:**
- TestCreateVM: POST /v1/vms with valid body → 201 + VM data
- TestCreateVM_Duplicate: POST with existing name → 409
- TestCreateVM_InvalidBody: POST with bad JSON → 400
- TestCreateVM_MissingName: POST with empty name → 400
- TestListVMs: GET /v1/vms → 200 + array (empty initially)
- TestGetVM: GET /v1/vms/test1 → 200 after creation
- TestGetVM_NotFound: GET /v1/vms/nonexistent → 404
- TestDeleteVM: DELETE /v1/vms/test1 → 200 after creation
- TestDeleteVM_NotFound: DELETE /v1/vms/nonexistent → 404
- TestStartVM: Requires Firecracker — skip if not available (integration test)
- TestStopVM: Requires Firecracker — skip
- TestListImages: GET /v1/images → 200 + array
- TestListKernels: GET /v1/kernels → 200 + array
- TestHostStatus: GET /v1/host/status → 200 + status data
- TestHealth: GET /v1/health → 200 + healthy status

### Middleware Tests (middleware_test.go)
- TestPanicRecovery: handler that panics → returns 500 JSON, server stays alive
- TestRequestLogging: verify log output contains method/path/status
- TestRequestID: verify X-Request-ID header on every response

## Testing Strategy
- Unit tests use httptest (no real server, no network)
- Tests that require Firecracker/root are skipped with t.Skip()
- Use t.TempDir() for all state directories
- Tests are parallelizable (each creates isolated state)

## Acceptance Criteria
- All handler happy paths have unit tests
- All error conditions (404, 409, 400) have unit tests
- Middleware behavior is tested
- Tests run without root privileges (Firecracker-dependent tests skipped)
- go test ./internal/api/ passes

## Acceptance Criteria

go test ./internal/api/ passes; all error codes covered; tests run without root

