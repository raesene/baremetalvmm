---
id: ba-0371
status: open
deps: [ba-dec6, ba-dca5]
links: []
created: 2026-01-29T18:13:59Z
type: task
priority: 1
assignee: vot3k
parent: ba-0cdb
---
# Implement TLS certificate generation tooling (vmm-ctl tls init)

## Objective
Implement a certificate generation command that creates all TLS certificates needed for mTLS between vmm-ctl and vmm-api instances.

## Location
- New file: internal/orchestrator/tls.go
- Add subcommand in cmd/vmm-ctl/main.go

## Implementation Details

### Command: vmm-ctl tls init
```bash
vmm-ctl tls init --output-dir ./certs --hosts host-a,host-b,host-c
```

### Certificate Chain
```
CA (self-signed)
├── Server cert (per host) — vmm-api presents this
│   CN: host-a, SAN: [192.168.1.10, host-a]
│   CN: host-b, SAN: [192.168.1.11, host-b]
└── Client cert — vmm-ctl presents this
    CN: vmm-ctl-client
```

### Generated Files
```
output-dir/
├── ca.crt              # CA certificate (distribute to all hosts + orchestrator)
├── ca.key              # CA private key (keep secure, used only for signing)
├── host-a/
│   ├── server.crt      # Server certificate for host-a
│   └── server.key      # Server private key for host-a
├── host-b/
│   ├── server.crt
│   └── server.key
└── client/
    ├── client.crt      # Client certificate for vmm-ctl
    └── client.key      # Client private key for vmm-ctl
```

### Implementation (using Go crypto/x509 stdlib)
```go
func GenerateCA(outputDir string) (*x509.Certificate, *rsa.PrivateKey, error)
func GenerateServerCert(ca *x509.Certificate, caKey *rsa.PrivateKey, hostName string, ips []net.IP, outputDir string) error
func GenerateClientCert(ca *x509.Certificate, caKey *rsa.PrivateKey, outputDir string) error
```

- CA validity: 10 years
- Server/client cert validity: 1 year
- Key type: RSA 4096 or Ed25519 (prefer Ed25519 for performance)
- Key usage: server certs get ServerAuth, client certs get ClientAuth
- SANs on server certs: IP addresses + hostnames from config

### Post-Generation Instructions
Print clear instructions:
1. Copy ca.crt to all hosts and the orchestrator
2. Copy host-specific server.crt/key to each host's /etc/vmm/tls/
3. Copy client.crt/key to orchestrator config dir
4. Update vmm-ctl config with cert paths
5. Restart vmm-api on each host

## Acceptance Criteria
- vmm-ctl tls init generates valid CA + server + client certs
- Server certs include correct SANs for each host
- Generated certs work with mTLS (vmm-api accepts vmm-ctl connections)
- No external dependencies (pure Go crypto/x509)
- Clear instructions printed after generation

## Acceptance Criteria

Generated certs enable mTLS between vmm-ctl and vmm-api; pure stdlib crypto

