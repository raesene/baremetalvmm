---
id: ba-1761
status: open
deps: []
links: []
created: 2026-01-29T18:12:36Z
type: task
priority: 1
assignee: vot3k
parent: ba-0380
---
# Implement placement logic and host selection strategies

## Objective
Create internal/orchestrator/placement.go — host selection strategies for VM placement.

## Location
- New file: internal/orchestrator/placement.go

## Implementation Details

### Strategy Interface
```go
type PlacementStrategy interface {
    SelectHost(hosts []*HostWithStatus, cpus, memoryMB int) (*HostWithStatus, error)
}

type HostWithStatus struct {
    Client *HostClient
    Status *HostStatus
}
```

### Least-Loaded Strategy (default)
```go
type LeastLoadedStrategy struct{}

func (s *LeastLoadedStrategy) SelectHost(hosts []*HostWithStatus, cpus, memoryMB int) (*HostWithStatus, error)
```
**Algorithm (from RFC):**
1. Filter hosts with sufficient resources (availCPUs >= cpus, availMem >= memoryMB)
2. Score each eligible host: score = (availCPUs/totalCPUs) + (availMem/totalMem)
3. Select host with highest score (most available relative capacity)
4. Return error if no host has sufficient resources

### Round-Robin Strategy
```go
type RoundRobinStrategy struct {
    counter uint64  // atomic counter
}
```
1. Filter hosts with sufficient resources
2. Select next host in rotation (atomic increment modulo host count)
3. Skip hosts without enough capacity

### Explicit Strategy (--host=X)
Not really a strategy — handled by the orchestrator before calling placement.
When --host is specified, bypass placement entirely and route to named host.

### Strategy Factory
```go
func NewStrategy(name string) (PlacementStrategy, error)
```
- "least-loaded" → LeastLoadedStrategy
- "round-robin" → RoundRobinStrategy
- Unknown → error

## Implementation Notes
- Host status is fetched in parallel by the orchestrator before calling SelectHost()
- Strategies receive pre-fetched status to avoid redundant API calls
- Unreachable hosts are excluded before strategy is invoked
- Strategy is configured in vmm-ctl config file

## Acceptance Criteria
- Least-loaded selects host with most available resources
- Round-robin distributes VMs evenly across hosts
- Both strategies reject hosts with insufficient resources
- Error returned when no host can fit the requested VM
- Strategy is selectable by name from config

## Acceptance Criteria

Least-loaded picks most-available host; round-robin distributes evenly; insufficient resources returns error

